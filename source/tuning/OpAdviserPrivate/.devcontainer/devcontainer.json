// For format details, see https://aka.ms/devcontainer.json. For config options, see the README.
{
	"name": "OpAdviser",
	"build": {
		"dockerfile": "Dockerfile",
		"context": "."
	},
	"workspaceFolder": "/workspaces/Conversational-Self-tunning-DBMS/source/tuning/OpAdviserPrivate",

	// Extensions to install in the container    
	"extensions": [
        "ms-python.python@2023.20.0",
        "ms-python.vscode-pylance@2023.11.10",
        "ms-python.debugpy@2024.0.0",
        "ms-python.black-formatter"
    ],

	// Keep the container running after closing the editor
	"shutdownAction": "none",

	// Runs as root when the container is created (before source code is fully available)
	"onCreateCommand": "sudo bash -x .devcontainer/setup.sh 2>&1 | tee /tmp/setup.log",
	
	// Runs after the container is created and source code is available
	// Installs project-specific packages and starts database population
	"postCreateCommand": "bash .devcontainer/post_create.sh 2>&1 | tee /tmp/post_create.log",
	
	// Runs every time the container starts
	// Ensure MySQL is always running and ready
	"postStartCommand": "bash -c 'sudo service mysql start 2>&1 || true; for i in {1..10}; do if mysql -u root -ppassword -h localhost -P 3306 -e \"SELECT 1\" >/dev/null 2>&1; then echo \"MySQL is ready on port 3306\"; break; fi; echo \"Waiting for MySQL... ($i/10)\"; sleep 1; done'",
	
	"customizations": {
		"vscode": {
			"extensions": [
				"ms-python.python@2023.20.0",
				"ms-python.vscode-pylance@2023.11.10",
				"ms-python.debugpy@2024.0.0",
				"ms-python.black-formatter"
			],
			"settings": {
				"python.defaultInterpreterPath": "/usr/bin/python3.8",
				"[python]": {
					"editor.defaultFormatter": "ms-python.black-formatter",
					"editor.formatOnSave": true
				},
				"python.formatting.provider": "none",
				"terminal.integrated.env.linux": {
					"PYTHONPATH": "/workspaces/Conversational-Self-tunning-DBMS/source/tuning/OpAdviserPrivate"
				}
			}
		}
	},

	"containerEnv": {
		"DOCKER_CLI_EXPERIMENTAL": "enabled",
		"PYTHONPATH": "/workspaces/Conversational-Self-tunning-DBMS/source/tuning/OpAdviserPrivate"
	},

	// THIS IS THE KEY FIX: Mount a temporary filesystem to /tmp with correct permissions
	"mounts": [
		"type=tmpfs,target=/tmp,tmpfs-mode=1777"
	],

	// Network configuration: DNS settings for name resolution
	// Using bridge mode (default) instead of host mode to avoid port conflicts
	"runArgs": [
		"--dns=141.223.1.2",
		"--dns=8.8.8.8"
	],

	// Connect as the non-root 'vscode' user
	"remoteUser": "vscode"
}
